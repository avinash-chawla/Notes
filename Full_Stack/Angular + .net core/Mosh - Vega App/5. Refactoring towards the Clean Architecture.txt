------------------------------------------------------------------------------------------

1. Intro

--> We are going to learn following topics:

--> Repository pattern
--> Unit of work pattern
--> Dependency Injection
--> Dependency inversion principle
--> Layers and tiers

--> Mosh's tips: Take a break of 10 mins after every 40 mins of work.

------------------------------------------------------------------------------------------

2. Seperating API Resources

--> We have an complex api
--> complex api means more branching in api
--> Including make, models, features

--> In GET Request, we need make, models, features (along with name, not with only id)

------------------------------------------------------------------------------------------

--> Solution1: Add name properties

{
   id: 1, 
   modelId : 1,
   modelName: "BMW",
   features: [1,2,3]
}

------------------------------------------------------------------------------------------

--> Solution2: Use nested objects

{ 
   id : 1,
   model: { id: 1, name: "BMW" }
   features: [
	{ id:1, name: "ABS Brakes"}
   ]
}

------------------------------------------------------------------------------------------

--> API Resources

1. Prevent the API contract from breaking
2. Prevent over-posting attacks

------------------------------------------------------------------------------------------

--> For Create/Update API, we use

{ 
   id: 1,
   modelId: 1,
   features: [1, 2, 3]
}

------------------------------------------------------------------------------------------

--> For Get API, we will use

{
   id: 1, 
   model: { id: 1, name: "." },
   features: [
	{ id : 1, name: "." }
   ]
}

------------------------------------------------------------------------------------------

--> We will create 3 APIResources for dealing with data

CreateVehicle(SaveVehicleResource resource)
UpdateVehicle(SaveVehicleResource resource)
VehicleResource GetVehicle(int id)

------------------------------------------------------------------------------------------

3. Refactoring

--> Rename VehicleResouce to SaveVehicleResource by pressing F2
--> Also change the fileName

--> Create new Resource file: VehicleResource

namespace Vega.API.Resources
{
    public class VehicleResource
    {
        public int Id { get; set; }

        public MakeResource Make { get; set; }
        public ModelResource Model { get; set; }

        public bool IsRegistered { get; set; }
        public DateTime LastUpdate { get; set; }

        public ContactResource Contact { get; set; }

        public ICollection<FeatureResource> Features { get; set; }

        public VehicleResource()
        {
            Features = new Collection<FeatureResource>();
        }
    }
}

------------------------------------------------------------------------------------------

--> Create Mapping for Vehicle to VehicleResource as this will be used for Get Request
--> In MappingProfile.cs,

 	CreateMap<Vehicle, VehicleResource>()
                .ForMember(vr => vr.Make, opt => opt.MapFrom(v => v.Model.Make))
                .ForMember(vr => vr.Contact, opt =>
                    opt.MapFrom(v => new ContactResource
                    {
                        Name = v.ContactName,
                        Email = v.ContactEmail,
                        Phone = v.ContactPhone
                    }))
                .ForMember(vr => vr.Features, opt =>
                    opt.MapFrom(v => v.Features.Select(vf =>
                                        new FeatureResource { Id = vf.Feature.Id, Name = vf.Feature.Name })));

------------------------------------------------------------------------------------------

--> Modifying Get(id) actionMethod

	[HttpGet("{id}")]
        public async Task<IActionResult> GetVehicle(int id)
        {
            var vehicle = await context.Vehicles
                                            .Include(v => v.Features)
                                                .ThenInclude(vf => vf.Feature)
                                            .Include(v => v.Model)
                                                .ThenInclude(m => m.Make)
                                            .SingleOrDefaultAsync(v => v.Id == id);

            if (vehicle == null)
                return NotFound();

            var vehicleResource = mapper.Map<Vehicle, VehicleResource>(vehicle);

            return Ok(vehicleResource);
        }

------------------------------------------------------------------------------------------

--> In VehicleResource.cs,

    public class VehicleResource
    {
        public int Id { get; set; }
        public MakeResource Make { get; set; }

------------------------------------------------------------------------------------------

--> In MappingProfile,

CreateMap<Vehicle, VehicleResource>()
                .ForMember(vr => vr.Make, opt => opt.MapFrom(v => v.Model.Make))

------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------




















































